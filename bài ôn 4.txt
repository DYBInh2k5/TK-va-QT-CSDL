b√†i √¥n 4
 1.1. T·∫°o Database
sql
Sao ch√©p
Ch·ªânh s·ª≠a
-- T·∫°o c∆° s·ªü d·ªØ li·ªáu
CREATE DATABASE QLChamCong;
GO

-- S·ª≠ d·ª•ng database v·ª´a t·∫°o
USE QLChamCong;
GO
üîπ 1.2. T·∫°o c√°c b·∫£ng
üì¶ B·∫£ng PhongBan
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE PhongBan (
    maphongban CHAR(3) NOT NULL,
    tenphongban NVARCHAR(100) NOT NULL,
    CONSTRAINT PK_PhongBan PRIMARY KEY (maphongban),
    CONSTRAINT CK_MaPhong CHECK (maphongban LIKE 'P[0-9][0-9]')
);
üîé CK_MaPhong: r√†ng bu·ªôc m√£ ph√≤ng b·∫Øt ƒë·∫ßu b·∫±ng P v√† 2 ch·ªØ s·ªë (VD: P01, P02)

üë§ B·∫£ng NhanVien
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE NhanVien (
    manhanvien CHAR(4) NOT NULL,
    hoten NVARCHAR(100) NOT NULL,
    luongcoban MONEY NOT NULL,
    maphongban CHAR(3) NOT NULL,
    CONSTRAINT PK_NhanVien PRIMARY KEY (manhanvien),
    CONSTRAINT FK_NV_Phong FOREIGN KEY (maphongban) REFERENCES PhongBan(maphongban)
);
üìä B·∫£ng BangChamCong
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE BangChamCong (
    mabangchamcong CHAR(4) NOT NULL,
    thang CHAR(7) NOT NULL,  -- ƒê·ªãnh d·∫°ng: MM/YYYY
    maphongban CHAR(3) NOT NULL,
    CONSTRAINT PK_BangCC PRIMARY KEY (mabangchamcong),
    CONSTRAINT FK_BCC_Phong FOREIGN KEY (maphongban) REFERENCES PhongBan(maphongban)
);
üìù B·∫£ng ChamCong
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE ChamCong (
    manhanvien CHAR(4) NOT NULL,
    mabangchamcong CHAR(4) NOT NULL,
    songaycong INT DEFAULT 26,  -- r√†ng bu·ªôc default
    CONSTRAINT PK_ChamCong PRIMARY KEY (manhanvien, mabangchamcong),
    CONSTRAINT FK_CC_NV FOREIGN KEY (manhanvien) REFERENCES NhanVien(manhanvien),
    CONSTRAINT FK_CC_BCC FOREIGN KEY (mabangchamcong) REFERENCES BangChamCong(mabangchamcong)
);
üîπ 1.3. Nh·∫≠p d·ªØ li·ªáu m·∫´u
sql
Sao ch√©p
Ch·ªânh s·ª≠a
-- D·ªØ li·ªáu ph√≤ng ban
INSERT INTO PhongBan VALUES
('P01', N'Ph√≤ng thu mua'),
('P02', N'Ph√≤ng s·∫£n xu·∫•t');

-- D·ªØ li·ªáu nh√¢n vi√™n
INSERT INTO NhanVien VALUES
('NV01', N'Hu·ª≥nh Th·ªã Th√∫y Anh', 7000000, 'P01'),
('NV02', N'L∆∞∆°ng Th·ªã Thanh B√¨nh', 7500000, 'P01'),
('NV03', N'Tr·∫ßn Th·ªã Kim Duy√™n', 8000000, 'P02'),
('NV04', N'Tr·∫ßn Th·ª•y Ph∆∞∆°ng ƒê√†i', 7000000, 'P02'),
('NV05', N'B√πi Thu H√†', 7500000, 'P02'),
('NV06', N'Nguy·ªÖn H·∫£i H√†', 8200000, 'P02');

-- D·ªØ li·ªáu b·∫£ng ch·∫•m c√¥ng
INSERT INTO BangChamCong VALUES
('B01', '01/2025', 'P01'),
('B02', '01/2025', 'P02'),
('B03', '02/2025', 'P01'),
('B04', '02/2025', 'P02');

-- D·ªØ li·ªáu ch·∫•m c√¥ng
INSERT INTO ChamCong VALUES
('NV01', 'B01', 20),
('NV02', 'B01', 21),
('NV03', 'B02', 23),
('NV04', 'B02', 24),
('NV05', 'B02', 26),
('NV06', 'B02', 25),
('NV01', 'B03', 24),
('NV02', 'B03', 26),
('NV03', 'B04', 23),
('NV04', 'B04', 22),
('NV05', 'B04', 23),
('NV06', 'B04', 24);

PH·∫¶N 2: TRUY V·∫§N (5 ƒëi·ªÉm)
üîé 2.1. T√¨m nh√¢n vi√™n c√≥ l∆∞∆°ng c∆° b·∫£n > 8 tri·ªáu
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
SELECT hoten, luongcoban
FROM NhanVien
WHERE luongcoban > 8000000;
üîé 2.2. T√¨m m√£ + h·ªç t√™n nh√¢n vi√™n thu·ªôc ph√≤ng s·∫£n xu·∫•t
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
SELECT manhanvien, hoten
FROM NhanVien
WHERE maphongban = 'P02';
üîé 2.3. T√¨m h·ªç t√™n nh√¢n vi√™n v√† t√™n ph√≤ng ban c·ªßa h·ªç
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
SELECT nv.hoten, pb.tenphongban
FROM NhanVien nv
JOIN PhongBan pb ON nv.maphongban = pb.maphongban;
üîé 2.4. T√™n ph√≤ng ban v√† s·ªë l∆∞·ª£ng nh√¢n vi√™n
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
SELECT pb.tenphongban, COUNT(nv.manhanvien) AS soluong_nv
FROM PhongBan pb
LEFT JOIN NhanVien nv ON pb.maphongban = nv.maphongban
GROUP BY pb.tenphongban;
üîé 2.5. L∆∞∆°ng th√°ng c·ªßa nh√¢n vi√™n t·ª´ng th√°ng
C√¥ng th·ª©c: l∆∞∆°ng th√°ng = (l∆∞∆°ng c∆° b·∫£n * s·ªë ng√†y c√¥ng) / 26

sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
SELECT nv.manhanvien, nv.hoten, bc.thang, 
       (nv.luongcoban * cc.songaycong) / 26 AS luong_thang
FROM ChamCong cc
JOIN NhanVien nv ON cc.manhanvien = nv.manhanvien
JOIN BangChamCong bc ON cc.mabangchamcong = bc.mabangchamcong;
‚úÖ PH·∫¶N 3: SCRIPT (X·ª≠ l√Ω b·∫£ng ch·∫•m c√¥ng)
üóëÔ∏è 3.1. X√≥a b·∫£ng ch·∫•m c√¥ng th√°ng 6/2025
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
DELETE FROM BangChamCong
WHERE thang = '06/2025';
üÜï 3.2. T·∫°o b·∫£ng ch·∫•m c√¥ng 6/2025 + ch·∫•m c√¥ng 26 ng√†y
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
-- T·∫°o b·∫£ng ch·∫•m c√¥ng
INSERT INTO BangChamCong VALUES
('B06_1', '06/2025', 'P01'),
('B06_2', '06/2025', 'P02');

-- Ch·∫•m c√¥ng t·∫•t c·∫£ nh√¢n vi√™n
INSERT INTO ChamCong
SELECT manhanvien,
       CASE 
           WHEN maphongban = 'P01' THEN 'B06_1'
           ELSE 'B06_2'
       END,
       26
FROM NhanVien;
‚úÖ PH·∫¶N 4: STORED PROCEDURES
üßæ Proc1: T√≠nh ng√†y c√¥ng + l∆∞∆°ng th√°ng c·ªßa 1 nh√¢n vi√™n
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_nhanvien_luong
    @manv CHAR(4),
    @thang CHAR(7),
    @songay INT OUTPUT,
    @luong MONEY OUTPUT
AS
BEGIN
    SELECT TOP 1 @songay = cc.songaycong,
                 @luong = (nv.luongcoban * cc.songaycong) / 26
    FROM ChamCong cc
    JOIN NhanVien nv ON cc.manhanvien = nv.manhanvien
    JOIN BangChamCong bc ON cc.mabangchamcong = bc.mabangchamcong
    WHERE cc.manhanvien = @manv AND bc.thang = @thang;
END;
üßæ Proc2: T·ªïng l∆∞∆°ng ph√≤ng ban theo th√°ng
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_tongluong_phong
    @maphong CHAR(3),
    @thang CHAR(7),
    @tongluong MONEY OUTPUT
AS
BEGIN
    SELECT @tongluong = SUM(nv.luongcoban * cc.songaycong / 26)
    FROM ChamCong cc
    JOIN NhanVien nv ON cc.manhanvien = nv.manhanvien
    JOIN BangChamCong bc ON cc.mabangchamcong = bc.mabangchamcong
    WHERE bc.maphongban = @maphong AND bc.thang = @thang;
END;
üßæ Proc3: C·∫≠p nh·∫≠t m√£ ph√≤ng ban v√† b·∫£ng ch·∫•m c√¥ng
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_chuyenphong
    @manv CHAR(4),
    @maphongmoi CHAR(3),
    @thang CHAR(7)
AS
BEGIN
    -- C·∫≠p nh·∫≠t m√£ ph√≤ng ban trong nh√¢n vi√™n
    UPDATE NhanVien
    SET maphongban = @maphongmoi
    WHERE manhanvien = @manv;

    -- T√¨m b·∫£ng ch·∫•m c√¥ng t∆∞∆°ng ·ª©ng
    DECLARE @bcc CHAR(4);
    SELECT TOP 1 @bcc = mabangchamcong
    FROM BangChamCong
    WHERE thang = @thang AND maphongban = @maphongmoi;

    -- C·∫≠p nh·∫≠t b·∫£ng ch·∫•m c√¥ng
    UPDATE ChamCong
    SET mabangchamcong = @bcc
    WHERE manhanvien = @manv;
END;
üßæ Proc4: T·ªïng ng√†y c√¥ng v√† l∆∞∆°ng chi c·ªßa to√†n c√¥ng ty th√°ng X
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_tongcong_congty
    @thang CHAR(7),
    @tongngay INT OUTPUT,
    @tongluong MONEY OUTPUT
AS
BEGIN
    SELECT @tongngay = SUM(cc.songaycong),
           @tongluong = SUM(nv.luongcoban * cc.songaycong / 26)
    FROM ChamCong cc
    JOIN NhanVien nv ON cc.manhanvien = nv.manhanvien
    JOIN BangChamCong bc ON cc.mabangchamcong = bc.mabangchamcong
    WHERE bc.thang = @thang;
END;
üßæ Proc6: TƒÉng l∆∞∆°ng cho nh√¢n vi√™n l∆∞∆°ng < 5 tri·ªáu, kh√¥ng v∆∞·ª£t qu·ªπ
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_nangluong
    @quyluong MONEY
AS
BEGIN
    DECLARE @tong_moi MONEY = 0;

    DECLARE cur CURSOR FOR
    SELECT manhanvien, luongcoban FROM NhanVien WHERE luongcoban < 5000000;

    DECLARE @manv CHAR(4), @luongcu MONEY, @luongmoi MONEY;

    OPEN cur;
    FETCH NEXT FROM cur INTO @manv, @luongcu;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @luongmoi = @luongcu * 1.1;
        IF @tong_moi + (@luongmoi - @luongcu) <= @quyluong
        BEGIN
            UPDATE NhanVien SET luongcoban = @luongmoi WHERE manhanvien = @manv;
            SET @tong_moi = @tong_moi + (@luongmoi - @luongcu);
        END

        FETCH NEXT FROM cur INTO @manv, @luongcu;
    END;

    CLOSE cur;
    DEALLOCATE cur;
END;
‚úÖ PH·∫¶N 5: TRIGGER
üö® Trigger: l∆∞∆°ng c∆° b·∫£n kh√¥ng qu√° 40 tri·ªáu
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_luong_max
ON NhanVien
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT * FROM inserted WHERE luongcoban > 40000000
    )
    BEGIN
        RAISERROR('L∆∞∆°ng c∆° b·∫£n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 40 tri·ªáu', 16, 1);
        ROLLBACK;
    END
END;
üö® Trigger: ph√≤ng s·∫£n xu·∫•t kh√¥ng c√≥ nh√¢n vi√™n < 10 ng√†y c√¥ng m·ªói th√°ng
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_cong_sp
ON ChamCong
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT * FROM inserted i
        JOIN NhanVien nv ON i.manhanvien = nv.manhanvien
        WHERE nv.maphongban = 'P02' AND i.songaycong < 10
    )
    BEGIN
        RAISERROR('Ph√≤ng s·∫£n xu·∫•t kh√¥ng ƒë∆∞·ª£c c√≥ nh√¢n vi√™n l√†m d∆∞·ªõi 10 ng√†y', 16, 1);
        ROLLBACK;
    END
END;
üö® Trigger: nh√¢n vi√™n ph·∫£i ch·∫•m c√¥ng ƒë√∫ng b·∫£ng ph√≤ng m√¨nh
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_cc_dungphong
ON ChamCong
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT * FROM inserted i
        JOIN BangChamCong bc ON i.mabangchamcong = bc.mabangchamcong
        JOIN NhanVien nv ON i.manhanvien = nv.manhanvien
        WHERE bc.maphongban <> nv.maphongban
    )
    BEGIN
        RAISERROR('Nh√¢n vi√™n ph·∫£i ƒë∆∞·ª£c ch·∫•m c√¥ng ƒë√∫ng ph√≤ng ban c·ªßa m√¨nh', 16, 1);
        ROLLBACK;
    END
END;
üö® Trigger: 1 ph√≤ng kh√¥ng ƒë∆∞·ª£c c√≥ >1 b·∫£ng c√¥ng/th√°ng
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_1bcc_1thang
ON BangChamCong
AFTER INSERT
AS
BEGIN
    IF EXISTS (
        SELECT maphongban, thang
        FROM BangChamCong
        GROUP BY maphongban, thang
        HAVING COUNT(*) > 1
    )
    BEGIN
        RAISERROR('1 ph√≤ng kh√¥ng ƒë∆∞·ª£c c√≥ h∆°n 1 b·∫£ng c√¥ng/th√°ng', 16, 1);
        ROLLBACK;
    END
END;
üö® Trigger: ph√≤ng thu mua kh√¥ng > 15 nh√¢n vi√™n
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_phong_thumuagia
ON NhanVien
AFTER INSERT, UPDATE
AS
BEGIN
    IF (SELECT COUNT(*) FROM NhanVien WHERE maphongban = 'P01') > 15
    BEGIN
        RAISERROR('Ph√≤ng thu mua kh√¥ng ƒë∆∞·ª£c c√≥ h∆°n 15 nh√¢n vi√™n', 16, 1);
        ROLLBACK;
    END
END;
‚úÖ PH·∫¶N 6: SECURITY
üë• T·∫°o Role
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
-- Role: NhanVien
CREATE ROLE nhanvien;
GRANT SELECT ON PhongBan TO nhanvien;
GRANT SELECT ON NhanVien TO nhanvien;
GRANT SELECT ON BangChamCong TO nhanvien;
GRANT SELECT ON ChamCong TO nhanvien;

-- Role: NhanSu
CREATE ROLE nhansu;
GRANT SELECT, INSERT, UPDATE, DELETE ON PhongBan TO nhansu;
GRANT SELECT, INSERT, UPDATE, DELETE ON NhanVien TO nhansu;
GRANT SELECT, INSERT, UPDATE, DELETE ON BangChamCong TO nhansu;

-- Role: NguoiChamCong
CREATE ROLE nguoichamcong;
GRANT SELECT, INSERT, UPDATE, DELETE ON ChamCong TO nguoichamcong;
üë§ T·∫°o user v√† g√°n role
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE USER VTTHA WITHOUT LOGIN;
EXEC sp_addrolemember 'nhanvien', 'VTTHA';

CREATE USER NguyenAnh WITHOUT LOGIN;
EXEC sp_addrolemember 'nhansu', 'NguyenAnh';

CREATE USER HoangLan WITHOUT LOGIN;
EXEC sp_addrolemember 'nguoichamcong', 'HoangLan';