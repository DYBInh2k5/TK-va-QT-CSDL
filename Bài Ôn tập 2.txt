B√†i √în t·∫≠p 2
‚úÖ PH·∫¶N 1: T·∫†O DATABASE, TABLE, R√ÄNG BU·ªòC
üß± 1.1. T·∫°o CSDL
sql
Sao ch√©p
Ch·ªânh s·ª≠a
-- T·∫°o database c√≥ t√™n QLThueXe
CREATE DATABASE QLThueXe;
GO

-- S·ª≠ d·ª•ng database v·ª´a t·∫°o
USE QLThueXe;
GO
üìã 1.2. T·∫°o c√°c b·∫£ng
B·∫£ng Xe
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE Xe (
    maxe CHAR(4) NOT NULL,                 -- V√≠ d·ª•: X01, X02
    tenxe NVARCHAR(100) NOT NULL,         -- T√™n xe, v√≠ d·ª•: Toyota Vios
    CONSTRAINT PK_Xe PRIMARY KEY (maxe),  -- Kh√≥a ch√≠nh: maxe
    CONSTRAINT CK_maxe CHECK (maxe LIKE 'X[0-9][0-9]')  -- CHECK: ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng X v√† 2 s·ªë
);
B·∫£ng KhachHang
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE KhachHang (
    makhach CHAR(5) NOT NULL,                 -- V√≠ d·ª•: KH01
    hoten NVARCHAR(100) NOT NULL,            -- H·ªç t√™n kh√°ch
    CONSTRAINT PK_Khach PRIMARY KEY (makhach)
);
B·∫£ng HopDongThueXe
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE HopDongThueXe (
    mahopdong CHAR(10) NOT NULL,               -- M√£ h·ª£p ƒë·ªìng
    ngaythue DATE DEFAULT GETDATE(),           -- Ng√†y thu√™, m·∫∑c ƒë·ªãnh l√† ng√†y hi·ªán h√†nh
    makhach CHAR(5) NOT NULL,                  -- Tham chi·∫øu ƒë·∫øn KhachHang
    CONSTRAINT PK_HopDong PRIMARY KEY (mahopdong),
    CONSTRAINT FK_HD_Khach FOREIGN KEY (makhach)
        REFERENCES KhachHang(makhach)
);
B·∫£ng ChiTietHopDong
sql
Sao ch√©p
Ch·ªânh s·ª≠a
CREATE TABLE ChiTietHopDong (
    mahopdong CHAR(10) NOT NULL,
    maxe CHAR(4) NOT NULL,
    ngaynhan DATE NOT NULL,
    ngaytra DATE NOT NULL,
    giathue MONEY NOT NULL,
    CONSTRAINT PK_CTHD PRIMARY KEY (mahopdong, maxe),
    CONSTRAINT FK_CTHD_HD FOREIGN KEY (mahopdong)
        REFERENCES HopDongThueXe(mahopdong),
    CONSTRAINT FK_CTHD_XE FOREIGN KEY (maxe)
        REFERENCES Xe(maxe)
);
üßæ 1.3. Nh·∫≠p d·ªØ li·ªáu
sql
Sao ch√©p
Ch·ªânh s·ª≠a
-- D·ªØ li·ªáu b·∫£ng Xe
INSERT INTO Xe VALUES
('X01', N'Toyota Vios'),
('X02', N'Toyota Camry'),
('X03', N'Hyundai i10 2024'),
('X04', N'Hyundai Venue 2023'),
('X05', N'Ford Everest');

-- D·ªØ li·ªáu b·∫£ng KhachHang
INSERT INTO KhachHang VALUES
('KH01', N'B√πi Thu H√†'),
('KH02', N'Nguy·ªÖn H·∫£i H√†');

-- D·ªØ li·ªáu b·∫£ng HopDongThueXe
INSERT INTO HopDongThueXe VALUES
('HD0001', '2025-02-01', 'KH01'),
('HD0002', '2025-03-07', 'KH02');

-- D·ªØ li·ªáu b·∫£ng ChiTietHopDong
INSERT INTO ChiTietHopDong VALUES
('HD0001', 'X01', '2025-02-03', '2025-02-06', 3000000),
('HD0001', 'X02', '2025-02-03', '2025-02-06', 3000000),
('HD0001', 'X03', '2025-02-04', '2025-02-06', 2000000),
('HD0002', 'X04', '2025-03-10', '2025-03-31', 15000000),
('HD0002', 'X01', '2025-03-08', '2025-03-09', 1000000);
‚úÖ PH·∫¶N 2: TRUY V·∫§N (5 ƒëi·ªÉm)
2.1. Kh√°ch h√†ng "Nguy·ªÖn H·∫£i H√†" ƒë√£ thu√™ nh·ªØng xe n√†o?
sql
Sao ch√©p
Ch·ªânh s·ª≠a
SELECT DISTINCT tenxe
FROM KhachHang kh
JOIN HopDongThueXe hd ON kh.makhach = hd.makhach
JOIN ChiTietHopDong ct ON hd.mahopdong = ct.mahopdong
JOIN Xe x ON ct.maxe = x.maxe
WHERE kh.hoten = N'Nguy·ªÖn H·∫£i H√†';
2.2. H·ªç t√™n kh√°ch h√†ng v√† t√™n xe ƒë√£ thu√™
sql
Sao ch√©p
Ch·ªânh s·ª≠a
SELECT kh.hoten, x.tenxe
FROM KhachHang kh
JOIN HopDongThueXe hd ON kh.makhach = hd.makhach
JOIN ChiTietHopDong ct ON hd.mahopdong = ct.mahopdong
JOIN Xe x ON ct.maxe = x.maxe;
2.3. M√£ xe, t√™n xe ch·ª©a t·ª´ "Toyota"
sql
Sao ch√©p
Ch·ªânh s·ª≠a
SELECT maxe, tenxe
FROM Xe
WHERE tenxe LIKE N'%Toyota%';
2.4. T·ªïng ti·ªÅn c·ªßa t·ª´ng h·ª£p ƒë·ªìng
sql
Sao ch√©p
Ch·ªânh s·ª≠a
SELECT mahopdong, SUM(giathue) AS TongTien
FROM ChiTietHopDong
GROUP BY mahopdong;
2.5. T√™n xe c√≥ t·ªïng ti·ªÅn thu√™ cao nh·∫•t
sql
Sao ch√©p
Ch·ªânh s·ª≠a
SELECT TOP 1 tenxe, SUM(giathue) AS TongTien
FROM Xe x
JOIN ChiTietHopDong ct ON x.maxe = ct.maxe
GROUP BY tenxe
ORDER BY SUM(giathue) DESC;

‚úÖ PH·∫¶N 3: SCRIPT X·ª¨ L√ù H·ª¢P ƒê·ªíNG
üõë 3.1. H·ªßy h·ª£p ƒë·ªìng v√†o ng√†y 30/2 ho·∫∑c 31/2 (ng√†y kh√¥ng th·ª±c t·∫ø)
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
DELETE hd
FROM HopDongThueXe hd
WHERE MONTH(ngaythue) = 2
  AND DAY(ngaythue) IN (30, 31);
‚ùó Ch√∫ √Ω: 30/2, 31/2 l√† ng√†y kh√¥ng t·ªìn t·∫°i, n√™n query n√†y ch·∫≥ng x√≥a g√¨, gi·ªëng gi·∫£ l·∫≠p h·ªßy h·ª£p ƒë·ªìng sai ng√†y.

üîÑ 3.2. Gh√©p h·ª£p ƒë·ªìng c√πng ng√†y v√† c√πng kh√°ch n·∫øu t·ªïng gi√° thu√™ < 100 tri·ªáu
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
;WITH CTE AS (
  SELECT makhach, ngaythue, 
         STRING_AGG(mahopdong, ',') AS ds_hd,
         SUM(giathue) AS tongtien
  FROM HopDongThueXe hd
  JOIN ChiTietHopDong ct ON hd.mahopdong = ct.mahopdong
  GROUP BY makhach, ngaythue
  HAVING COUNT(DISTINCT hd.mahopdong) > 1
     AND SUM(giathue) < 100000000
)
-- X√≥a c√°c h·ª£p ƒë·ªìng c≈©
DELETE hd
FROM HopDongThueXe hd
JOIN CTE c ON hd.makhach = c.makhach AND hd.ngaythue = c.ngaythue;

-- T·∫°o h·ª£p ƒë·ªìng m·ªõi g·ªôp
INSERT INTO HopDongThueXe (mahopdong, ngaythue, makhach)
SELECT ds_hd, ngaythue, makhach
FROM CTE;
‚úÇÔ∏è 3.3. T√°ch h·ª£p ƒë·ªìng nhi·ªÅu lo·∫°i xe th√†nh m·ªói h·ª£p ƒë·ªìng 1 xe
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
DECLARE @hd CHAR(10), @xe CHAR(4), @newHD CHAR(10), @i INT = 1;

DECLARE cur CURSOR FOR
SELECT mahopdong, maxe
FROM ChiTietHopDong
ORDER BY mahopdong;

OPEN cur;
FETCH NEXT FROM cur INTO @hd, @xe;

WHILE @@FETCH_STATUS = 0
BEGIN
    SET @newHD = @hd + RIGHT('0' + CAST(@i AS VARCHAR), 2);
    INSERT INTO HopDongThueXe 
        (mahopdong, ngaythue, makhach)
    SELECT @newHD, ngaythue, makhach
    FROM HopDongThueXe WHERE mahopdong = @hd;

    INSERT INTO ChiTietHopDong
        SELECT @newHD, maxe, ngaynhan, ngaytra, giathue
        FROM ChiTietHopDong
        WHERE mahopdong = @hd AND maxe = @xe;

    FETCH NEXT FROM cur INTO @hd, @xe;
    SET @i = @i + 1;
END;

CLOSE cur;
DEALLOCATE cur;

-- Cu·ªëi c√πng c√≥ th·ªÉ x√≥a h·ª£p ƒë·ªìng g·ªëc n·∫øu mu·ªën
-- DELETE FROM ChiTietHopDong WHERE mahopdong LIKE 'HD000%';
‚úÖ PH·∫¶N 4: STORED PROCEDURES
üßæ Proc1: Tham s·ªë @mahd, xu·∫•t t·ªïng ti·ªÅn v√† s·ªë xe
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_hd_info
    @mahd CHAR(10),
    @tongtien MONEY OUTPUT,
    @soluong INT OUTPUT
AS
BEGIN
    SELECT @tongtien = SUM(giathue),
           @soluong = COUNT(*)
    FROM ChiTietHopDong
    WHERE mahopdong = @mahd;
END;
GO
üßæ Proc2: Tham s·ªë @tenxe,@thang, t√≠nh t·ªïng ti·ªÅn cho thu√™ xe trong th√°ng
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_tien_theoxe
    @tenxe NVARCHAR(100),
    @thang INT,
    @tien OUTPUT MONEY
AS
BEGIN
    SELECT @tien = SUM(ct.giathue)
    FROM ChiTietHopDong ct
    JOIN Xe x ON ct.maxe = x.maxe
    JOIN HopDongThueXe hd ON ct.mahopdong = hd.mahopdong
    WHERE x.tenxe = @tenxe
      AND MONTH(hd.ngaythue) = @thang;
END;
GO
üßæ Proc3: @makh, @soxe, @songay, @ngaynhan: t·∫°o h·ª£p ƒë·ªìng v√† chi ti·∫øt
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_new_hd
    @makh CHAR(5),
    @soxe INT,
    @songay INT,
    @ngaynhan DATE
AS
BEGIN
    DECLARE @newHD CHAR(10) = CONCAT('HD', FORMAT(GETDATE(), 'yyyyMMddHHmmss'));
    INSERT INTO HopDongThueXe(mahopdong, makhach) VALUES(@newHD, @makh);
    INSERT INTO ChiTietHopDong(mahopdong, maxe, ngaynhan, ngaytra, giathue)
    SELECT TOP(@soxe) @newHD, maxe, @ngaynhan, DATEADD(DAY, @songay, @ngaynhan), 0
    FROM Xe;
END;
GO
üßæ Proc4: T√≠nh t·ªïng ti·ªÅn thu√™ cho kh√°ch @makh
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_tien_kh
   @makh CHAR(5),
   @tongtien MONEY OUTPUT
AS
BEGIN
    SELECT @tongtien = SUM(ct.giathue)
    FROM ChiTietHopDong ct
    JOIN HopDongThueXe hd ON ct.mahopdong = hd.mahopdong
    WHERE hd.makhach = @makh;
END;
GO
üßæ Proc6: Danh s√°ch t√™n xe thu√™ ƒë·ªß 12 th√°ng v·ªõi doanh thu >=10 tri·ªáu/th√°ng
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE PROCEDURE proc_xe_luat1nam
    @nam INT
AS
BEGIN
    SELECT x.tenxe
    FROM Xe x
    JOIN ChiTietHopDong ct ON x.maxe = ct.maxe
    JOIN HopDongThueXe hd ON ct.mahopdong = hd.mahopdong
    WHERE YEAR(hd.ngaythue) = @nam
    GROUP BY x.tenxe
    HAVING COUNT(DISTINCT MONTH(hd.ngaythue)) = 12
       AND MIN(
          CASE WHEN MONTH(hd.ngaythue)=1 THEN SUM(ct.giathue) END
       ) >= 10000000;
END;
GO
‚úÖ PH·∫¶N 5: TRIGGER KI·ªÇM TRA BUSINESS RULES
üéØ Trigger: T·ªïng ti·ªÅn 1 h·ª£p ƒë·ªìng kh√¥ng qu√° 100 tri·ªáu
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_chk_hd_tongtien
ON ChiTietHopDong
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
      SELECT ct.mahopdong
      FROM ChiTietHopDong ct
      GROUP BY ct.mahopdong
      HAVING SUM(giathue) > 100000000
    )
    BEGIN
        RAISERROR('T·ªïng ti·ªÅn h·ª£p ƒë·ªìng kh√¥ng ƒë∆∞·ª£c >100 tri·ªáu', 16,1);
        ROLLBACK TRANSACTION;
    END
END;
GO
üö´ Trigger: "Nguy·ªÖn H·∫£i H√†" kh√¥ng thu√™ xe Toyota
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_no_nhh_toyota
ON ChiTietHopDong
AFTER INSERT
AS
BEGIN
    IF EXISTS (
      SELECT 1
      FROM inserted i
      JOIN HopDongThueXe hd ON i.mahopdong = hd.mahopdong
      JOIN KhachHang kh ON hd.makhach = kh.makhach
      JOIN Xe x ON i.maxe = x.maxe
      WHERE kh.hoten = N'Nguy·ªÖn H·∫£i H√†' AND x.tenxe LIKE N'%Toyota%'
    )
    BEGIN
        RAISERROR('Nguy·ªÖn H·∫£i H√† kh√¥ng ƒë∆∞·ª£c thu√™ xe Toyota', 16,1);
        ROLLBACK TRANSACTION;
    END
END;
GO
üöó Trigger: 1 xe kh√¥ng ƒë∆∞·ª£c thu√™ tr√πng th·ªùi ƒëi·ªÉm
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_no_double_rent
ON ChiTietHopDong
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
      SELECT i.maxe
      FROM inserted i
      JOIN ChiTietHopDong ct ON i.maxe = ct.maxe
      WHERE i.mahopdong <> ct.mahopdong
        AND i.ngaynhan <= ct.ngaytra AND ct.ngaynhan <= i.ngaytra
    )
    BEGIN
        RAISERROR('Xe ƒë√£ ƒë∆∞·ª£c thu√™ tr√πng th·ªùi ƒëi·ªÉm', 16,1);
        ROLLBACK TRANSACTION;
    END
END;
GO
üü¢ Trigger: Ki·ªÉm tra ng√†y nh·∫≠n < ng√†y tr·∫£
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_chk_dates
ON ChiTietHopDong
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
      SELECT 1 FROM inserted i
      WHERE i.ngaynhan >= i.ngaytra
    )
    BEGIN
        RAISERROR('ngaynhan ph·∫£i < ngaytra', 16,1);
        ROLLBACK TRANSACTION;
    END
END;
GO
üí∞ Trigger: Toyota kh√¥ng thu√™ d∆∞·ªõi 500K/ng√†y
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_chk_toyota_price
ON ChiTietHopDong
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
      SELECT 1
      FROM inserted i
      JOIN Xe x ON i.maxe = x.maxe
      WHERE x.tenxe LIKE N'%Toyota%'
        AND i.giathue < 500000 * DATEDIFF(DAY, i.ngaynhan, i.ngaytra)
    )
    BEGIN
        RAISERROR('Xe Toyota kh√¥ng cho thu√™ d∆∞·ªõi 500k/ng√†y', 16,1);
        ROLLBACK TRANSACTION;
    END
END;
GO
üïê Trigger: Hyundai thu√™ t·ªëi thi·ªÉu 2 ng√†y
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE TRIGGER trg_chk_hyundai_days
ON ChiTietHopDong
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
      SELECT 1
      FROM inserted i
      JOIN Xe x ON i.maxe = x.maxe
      WHERE x.tenxe LIKE N'%Hyundai%'
        AND DATEDIFF(DAY, i.ngaynhan, i.ngaytra) < 2
    )
    BEGIN
        RAISERROR('Xe Hyundai ph·∫£i thu√™ t·ªëi thi·ªÉu 2 ng√†y', 16,1);
        ROLLBACK TRANSACTION;
    END
END;
GO
‚úÖ PH·∫¶N 6: SECURITY ‚Äì ROLE & USER
üõ°Ô∏è T·∫°o role & ph√¢n quy·ªÅn
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE ROLE ChuCuaHang;
GRANT SELECT ON Xe TO ChuCuaHang;
GRANT SELECT ON KhachHang TO ChuCuaHang;
GRANT SELECT ON HopDongThueXe TO ChuCuaHang;
GRANT SELECT ON ChiTietHopDong TO ChuCuaHang;

CREATE ROLE Khach;
GRANT SELECT ON HopDongThueXe TO Khach;
GRANT SELECT ON ChiTietHopDong TO Khach;

CREATE ROLE Nhanvien;
GRANT SELECT, INSERT, UPDATE, DELETE ON Xe TO Nhanvien;
GRANT SELECT, INSERT, UPDATE, DELETE ON KhachHang TO Nhanvien;
GRANT SELECT, INSERT, UPDATE, DELETE ON HopDongThueXe TO Nhanvien;
GRANT SELECT, INSERT, UPDATE, DELETE ON ChiTietHopDong TO Nhanvien;
üë§ T·∫°o user v√† g√°n role
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1
CREATE USER VTTHA WITHOUT LOGIN;
EXEC sp_addrolemember 'ChuCuaHang', 'VTTHA';

CREATE USER NguyenAnh WITHOUT LOGIN;
EXEC sp_addrolemember 'Nhanvien', 'NguyenAnh';

CREATE USER HoangLan WITHOUT LOGIN;
EXEC sp_addrolemember 'Khach', 'HoangLan';
‚úÖ Ki·ªÉm tra quy·ªÅn c·ªßa user
sql
Sao ch√©p
Ch·ªânh s·ª≠a
--SQL1 -- Gi·∫£ s·ª≠ b·∫°n ƒëang ƒëƒÉng nh·∫≠p l√† VTTHA
SELECT * FROM Xe;           -- ƒê∆∞·ª£c ph√©p
INSERT INTO Xe(...)        -- B·ªã l·ªói n·∫øu kh√¥ng ph·∫£i `Nhanvien`